<?php
//*****************************************************************************
//*****************************************************************************
/**
 * Aommand Line App Class
 *
 * @package         phpOpenFW
 * @author          Christian J. Clark
 * @copyright       Copyright (c) Christian J. Clark
 * @license         https://mit-license.org
 **/
//*****************************************************************************
//*****************************************************************************

namespace phpOpenFW\CLI;

//*****************************************************************************
/**
 * App Class
 */
//*****************************************************************************
class App
{
    //*************************************************************************
    //*************************************************************************
    // Traits
    //*************************************************************************
    //*************************************************************************
    use Traits\CoreCLI;

    //*************************************************************************
    //*************************************************************************
    // Class Members
    //*************************************************************************
    //*************************************************************************

    //*************************************************************************
    //*************************************************************************
    // Run App
    //*************************************************************************
    //*************************************************************************
    public function Run()
    {
        //=====================================================================
        // Pre-run Method
        //=====================================================================
        if ($this->CustomMethodExists('PreRun')) {
            $this->PreRun();
        }

        //=====================================================================
        // Extract Arguments
        //=====================================================================
        extract($this->args , EXTR_PREFIX_ALL, 'arg');

        //=====================================================================
        // App Pre-Script File
        //=====================================================================
        $pre_script = "{$this->app_path}/pre_app.inc.php";
        if (file_exists($pre_script)) {
            include($pre_script);
        }

        //=====================================================================
        // Check Job and Command Parameters
        //=====================================================================
        if (empty($this->args['j']) && empty($this->args['__command'])) {
            self::PrintErrorExit('No job (-j) or command (<script> [COMMAND]) given.');
        }
        if (!empty($this->args['__command'])) {
            $command1 = $this->args['__command'];
            $command1_dir = "{$this->app_path}/controllers/{$command1}";
        }
        if (!empty($this->args['j'])) {
            $command2 = $this->args['j'];
            $command2_dir = "{$this->app_path}/controllers/{$command2}";
        }

        //=====================================================================
        // Set Job, Job Directory, and Job Controller
        //=====================================================================
        if (is_dir($command1_dir)) {
            $job = $command1;
        }
        else if (is_dir($command2_dir)) {
            $job = $command2;
        }
        else {
            self::PrintErrorExit('Unknown command or job.');
        }
        $job_dir = "{$this->app_path}/controllers/{$job}";
        $job_controller = "{$job_dir}/controller.php";

        //=====================================================================
        // Job Controller
        //=====================================================================
        if (!file_exists($job_controller)) {
            self::PrintErrorExit('Unable to find command or job controller.');
        }

        //=====================================================================
        // Default Title
        //=====================================================================
        $this->mod_title = $job;

        //=====================================================================
        // Job local.inc.php
        //=====================================================================
        $job_local = "{$job_dir}/local.var.php";
        if (file_exists($job_local)) {
            include($job_local);
            if (!empty($mod_title)) {
                $this->mod_title = $mod_title;
            }
        }

        //=====================================================================
        // Job Title
        //=====================================================================
        $this->PrintTitle($this->mod_title);

        //=====================================================================
        // Environment
        // Run Mode
        // Verbose
        //=====================================================================
        $this->SetEnv();
        $this->SetRunMode();
        $this->SetVerbose();

        //=====================================================================
        // Call Controller
        //=====================================================================
        $this->PrintOutputHeader();
        include($job_controller);

        //=====================================================================
        // App Post-Script File
        //=====================================================================
        $post_script = "{$this->app_path}/post_app.inc.php";
        if (file_exists($post_script)) {
            include($post_script);
        }

        //=====================================================================
        // Post-run Method
        //=====================================================================
        if ($this->CustomMethodExists('PostRun')) {
            $this->PostRun();
        }
    }
}

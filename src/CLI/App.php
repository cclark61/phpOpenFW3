<?php
//*****************************************************************************
//*****************************************************************************
/**
 * Command Line App Class
 *
 * @package         phpOpenFW
 * @author          Christian J. Clark
 * @copyright       Copyright (c) Christian J. Clark
 * @license         https://mit-license.org
 **/
//*****************************************************************************
//*****************************************************************************

namespace phpOpenFW\CLI;

//*****************************************************************************
/**
 * App Class
 */
//*****************************************************************************
class App extends Core
{
    //*************************************************************************
    //*************************************************************************
    // Class Members
    //*************************************************************************
    //*************************************************************************
    protected $mod_title = false;
    protected $job = false;
    protected $job_dir = false;
    protected $job_controller = false;

    //*************************************************************************
    //*************************************************************************
    // Run App
    //*************************************************************************
    //*************************************************************************
    public function Run()
    {
        //=====================================================================
        // Pre-run Method
        //=====================================================================
        if ($this->CustomMethodExists('PreRun')) {
            $this->PreRun($this->args);
        }

        //=====================================================================
        // Environment
        // Run Mode
        // Verbose
        //=====================================================================
        $this->SetVerbose();
        $this->SetEnv();
        $this->SetRunMode();

        //=====================================================================
        // Determine Controller
        //=====================================================================
        if (!$this->DetermineController()) {
            $this->RunHelp();
        }
        //=====================================================================
        // Run Module
        //=====================================================================
        else {
            $this->RunModule();
        }

        //=====================================================================
        // Post-run Method
        //=====================================================================
        if ($this->CustomMethodExists('PostRun')) {
            $this->PostRun($this->args);
        }
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    // Internal Methods
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    //*************************************************************************
    //*************************************************************************
    // Run Module
    //*************************************************************************
    //*************************************************************************
    protected function RunModule(Array $args=[])
    {
        //=====================================================================
        // Default Options
        //=====================================================================
        $is_help = false;

        //=====================================================================
        // Extract Arguments
        //=====================================================================
        extract($this->args , EXTR_PREFIX_ALL, 'arg');
        extract($args);

        //=====================================================================
        // App Pre-Script File
        //=====================================================================
        $pre_script = "{$this->app_path}/pre_app.inc.php";
        if (file_exists($pre_script)) {
            include($pre_script);
        }

        //=====================================================================
        // Job Controller
        //=====================================================================
        if (!file_exists($this->job_controller)) {
            $err_msg = 'Unable to find command or job controller.';
            if ($is_help) {
                self::PrintErrorExit($err_msg);
            }
            else {
                self::PrintError($err_msg);
                $this->RunHelp();
            }
        }

        //=====================================================================
        // Job local.inc.php
        //=====================================================================
        $job_local = "{$this->job_dir}/local.var.php";
        if (file_exists($job_local)) {
            include($job_local);
            if (isset($mod_title)) {
                $this->mod_title = $mod_title;
            }
        }

        //=====================================================================
        // Job Title
        //=====================================================================
        if ($this->mod_title) {
            $this->PrintTitle($this->mod_title);
        }

        //=====================================================================
        // Call Controller
        //=====================================================================
        //$this->PrintHeader('Job Output');
        include($this->job_controller);

        //=====================================================================
        // App Post-Script File
        //=====================================================================
        $post_script = "{$this->app_path}/post_app.inc.php";
        if (file_exists($post_script)) {
            include($post_script);
        }
    }

    //*************************************************************************
    //*************************************************************************
    // Run Help Module
    //*************************************************************************
    //*************************************************************************
    protected function RunHelp()
    {
        $this->job = 'help';
        $this->job_dir = "{$this->app_path}/controllers/{$this->job}";
        $this->job_controller = "{$this->job_dir}/controller.php";
        if (!is_dir($this->job_dir) || !file_exists($this->job_controller)) {
            self::PrintErrorExit('Help module is not setup.');
        }
        $this->RunModule([
            'is_help' => true
        ]);
    }

    //*************************************************************************
    //*************************************************************************
    // Determine Controller
    //*************************************************************************
    //*************************************************************************
    protected function DetermineController()
    {
        //=====================================================================
        // Help Command?
        //=====================================================================
        if (empty($this->args['__command']) && empty($this->args['j'])) {
            return false;
        }
        if (array_key_exists('h', $this->args) || array_key_exists('help', $this->args) || $this->args['__command'] == 'help') {
            return false;
        }
        else {
            //=================================================================
            // Check Job and Command Parameters
            //=================================================================
            if (empty($this->args['j']) && empty($this->args['__command'])) {
                self::PrintErrorExit('No job (-j) or command (<script> [COMMAND]) given.');
                return false;
            }
            if (!empty($this->args['__command'])) {
                $command1 = $this->args['__command'];
                $command1_dir = "{$this->app_path}/controllers/{$command1}";
            }
            if (!empty($this->args['j'])) {
                $command2 = $this->args['j'];
                $command2_dir = "{$this->app_path}/controllers/{$command2}";
            }

            //=================================================================
            // Set Job, Job Directory, and Job Controller
            //=================================================================
            if (!empty($command1_dir) && is_dir($command1_dir)) {
                $this->job = $command1;
            }
            else if (!empty($command2_dir) && is_dir($command2_dir)) {
                $this->job = $command2;
            }
            else {
                $this->RunHelp();
            }
            $this->job_dir = "{$this->app_path}/controllers/{$this->job}";
            $this->job_controller = "{$this->job_dir}/controller.php";
        }

        //=====================================================================
        // Success
        //=====================================================================
        return true;
    }

}

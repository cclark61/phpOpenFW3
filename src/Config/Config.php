<?php
//*****************************************************************************
//*****************************************************************************
/**
 * Config Class
 *
 * @package         phpopenfw/phpopenfw3
 * @author          Christian J. Clark
 * @copyright       Copyright (c) Christian J. Clark
 * @website         https://phpopenfw.org
 * @license         https://mit-license.org
 **/
//*****************************************************************************
//*****************************************************************************

namespace phpOpenFW\Config;

//*****************************************************************************
/**
 * Config Class
 */
//*****************************************************************************
class Config implements \ArrayAccess, \Countable
{
    //*************************************************************************
    // Class Members
    //*************************************************************************
    protected $config_data = false;
    protected $display_errors = false;

    //*************************************************************************
    //*************************************************************************
    // Get Instance
    //*************************************************************************
    //*************************************************************************
    public static function Instance(Array $args=[])
    {
        //=====================================================================
        // Return New AppConfig Object
        //=====================================================================
        return new static($args);
    }

    //*************************************************************************
    //*************************************************************************
    // Constructor function
    //*************************************************************************
    //*************************************************************************
    public function __construct(Array $args=[])
    {
        //---------------------------------------------------------------------
        // Set Defaults / Args
        //---------------------------------------------------------------------
        $display_errors = false;
        extract($args);
        $this->display_errors = $display_errors;
        $this->config_data = new \stdClass();
    }

    //*************************************************************************
    //*************************************************************************
    // Export Configuration
    //*************************************************************************
    // Formats: array (default), json, raw
    //*************************************************************************
    //*************************************************************************
    public function Export($format='')
    {
        if ($format == 'raw') {
            return $this->config_data;
        }
        else if ($format == 'json') {
            return json_encode($this->config_data);
        }
        else {
            return (array)$this->config_data;
        }
    }

    //*************************************************************************
    //*************************************************************************
    // Set Config Values
    //*************************************************************************
    //*************************************************************************
    public function SetConfigValues($values, $overwrite=false)
    {
        if (!is_iterable($values)) {
            return false;
        }

        foreach ($values as $index => $value) {
            if (is_iterable($value)) {
                if (!isset($this->config_data->$index)) {
                    $this->config_data->$index = new \phpOpenFW\Config\Config();
                }
                else if (!is_object($this->config_data->$index) || get_class($this->config_data->$index) != 'phpOpenFW\Config\Config') {
                    return false;
                }
                $this->config_data->$index->SetConfigValues($value, $overwrite);
            }
            else {
                $this->SetConfigValue($index, $value);
            }
        }

        return true;
    }

    //*************************************************************************
    //*************************************************************************
    // Set Config Value
    //*************************************************************************
    //*************************************************************************
    public function SetConfigValue($index, $value, $overwrite=false)
    {
        if (!is_scalar($index) || $index == '') {
            throw new \Exception('Invalid index used to set value.');
        }

        if (isset($this->config_data->$index) && !$overwrite) {
            return false;
        }

        if (is_iterable($value)) {
            return $this->SetConfigValues($value, $overwrite);
        }
        else {
            $this->config_data->$index = $value;
        }

        return true;
    }

    //*************************************************************************
    //*************************************************************************
    // Get Config Value
    //*************************************************************************
    //*************************************************************************
    public function GetConfigValue($index, $format='')
    {
        if (!is_scalar($index) || $index == '') {
            throw new \Exception('Invalid index used to get value.');
        }
        if (is_null($index)) {
            $index = 'i' . $index;
        }
        if (isset($this->config_data->$index)) {
            $val = $this->config_data->$index;
            if ($format == 'array') {
                if (is_object($val) && get_class($val) == 'phpOpenFW\Config\Config') {
                    $val = $val->Export();
                }
            }
            else if ($format == 'json') {
                if (is_object($val) && get_class($val) == 'phpOpenFW\Config\Config') {
                    $val = $val->Export('json');
                }
            }
            return $val;
        }

        return null;
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    // Countable Interface
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    //*************************************************************************
    //*************************************************************************
    // Count
    //*************************************************************************
    //*************************************************************************
    public function count()
    {
        return count((array)$this->config_data);
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    // Array Access Interface Methods
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    //*************************************************************************
    //*************************************************************************
    // Set
    //*************************************************************************
    //*************************************************************************
    public function offsetSet($offset, $value)
    {
        if (is_null($offset)) {
            $count = 0;
            $offset = 'i' . $count;
            while (isset($this->config_data->$index)) {
                $count++;
                $offset = 'i' . $count;
            }
        }
        $this->config_data->$offset = $value;
    }

    //*************************************************************************
    //*************************************************************************
    // Isset
    //*************************************************************************
    //*************************************************************************
    public function offsetExists($offset)
    {
        return isset($this->config_data->$offset);
    }

    //*************************************************************************
    //*************************************************************************
    // Unset
    //*************************************************************************
    //*************************************************************************
    public function offsetUnset($offset)
    {
        unset($this->config_data->$offset);
    }

    //*************************************************************************
    //*************************************************************************
    // Get
    //*************************************************************************
    //*************************************************************************
    public function offsetGet($offset)
    {
        return $this->GetConfigValue($offset, 'array');
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    // Magic Methods
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    //*************************************************************************
    //*************************************************************************
    // Set
    //*************************************************************************
    //*************************************************************************
    public function __set($index, $value)
    {
        return $this->SetConfigValue($index, $value);
    }

    //*************************************************************************
    //*************************************************************************
    // Get
    //*************************************************************************
    //*************************************************************************
    public function __get($index)
    {
        return $this->GetConfigValue($index);
    }

    //*************************************************************************
    //*************************************************************************
    // Isset
    //*************************************************************************
    //*************************************************************************
    public function __isset($index)
    {
        if (is_scalar($index) && $index != '') {
            return isset($this->config_data->$index);
        }
        return false;
    }

    //*************************************************************************
    //*************************************************************************
    // Unset
    //*************************************************************************
    //*************************************************************************
    public function __unset($index)
    {
        if (is_scalar($index) && $index != '') {
            unset($this->config_data->$index);
            return true;
        }
        return false;
    }
}

<?php
//*****************************************************************************
//*****************************************************************************
/**
 * Command Line Interface Class
 *
 * @package		phpOpenFW
 * @author 		Christian J. Clark
 * @copyright	Copyright (c) Christian J. Clark
 * @license		https://mit-license.org
 **/
//*****************************************************************************
//*****************************************************************************

namespace phpOpenFW\CLI;

//*****************************************************************************
/**
 * CLI Class
 */
//*****************************************************************************
class CLI
{
	//*************************************************************************
	//*************************************************************************
	// Class Members
	//*************************************************************************
	//*************************************************************************
	protected $app_path = false;
	protected $config = [];
	protected $args = [];
	protected $mod_title = false;

	//*************************************************************************
	//*************************************************************************
	// Get Instanace
	//*************************************************************************
	//*************************************************************************
	public static function GetInstance($app_path, $raw_args)
	{
    	//=====================================================================
		// Valid Environment?
    	//=====================================================================
		if (strtoupper(php_sapi_name()) != 'CLI') {
			self::PrintError('Invalid environment.');
			exit;
		}
    	//=====================================================================
		// Validate App Path
    	//=====================================================================
		if (!is_dir($app_path)) {
			self::PrintError('Invalid application path.');
			return false;
		}

    	//=====================================================================
		// Parse Arguments
    	//=====================================================================
		if (!$args = self::ParseArgs($raw_args)) {
			self::PrintError('Invalid arguments.');
			return false;
		}

    	//=====================================================================
		// Return New CLI Object
    	//=====================================================================
		return new static($app_path, $args);
	}

	//*************************************************************************
	//*************************************************************************
	// Constructor
	//*************************************************************************
	//*************************************************************************
	public function __construct($app_path, Array $args=[])
	{
		//=====================================================================
        // Initialize App
		//=====================================================================
		$this->app_path = $app_path;
		define('CLI_APP_ROOT', $app_path);
		$this->args = $args;

		//=====================================================================
		// Initialize phpOpenFW
		//=====================================================================
		\phpOpenFW\Core::Bootstrap($app_path);

		//=====================================================================
        // Load Configuration
		//=====================================================================
		$config = \phpOpenFW\Core::LoadConfiguration();
		if ($config && $config->IsValid()) {
			$this->config = $config->Export();
		}

    	//=====================================================================
    	// Load Data Sources
    	//=====================================================================
    	\phpOpenFW\Core::LoadDataSources();
	}

	//*************************************************************************
	//*************************************************************************
	// Run Job
	//*************************************************************************
	//*************************************************************************
	public function Run()
	{
        self::PrintWarning('No Run method.');
	}

	//*************************************************************************
	//*************************************************************************
	// Run Job
	//*************************************************************************
	//*************************************************************************
	protected static function SetEnv()
	{
		//---------------------------------------------------------
		// Environment from CLI
		//---------------------------------------------------------
		if (!empty($this->args['env'])) {
			define('ENV', $this->args['env']);
		}
		//---------------------------------------------------------
		// Environment from Config
		//---------------------------------------------------------
		else if (!empty($this->config['env'])) {
			define('ENV', $this->config['env']);
		}
		//---------------------------------------------------------
		// Environment from GLOBALS
		//---------------------------------------------------------
		else if (!empty($GLOBALS['env'])) {
			define('ENV', $GLOBALS['env']);
		}

		//---------------------------------------------------------
		// Display Environment
		//---------------------------------------------------------
		if (defined('ENV')) {
			$env = ENV;
			$tmp_msg = "Environment is '{$env}'";
			self::PrintMessage($tmp_msg, 0, '*');
		}
    }

	//*************************************************************************
	//*************************************************************************
	// Parse Arguments
	//*************************************************************************
	//*************************************************************************
	protected static function ParseArgs($args)
	{
		//print_r($args);
		$num_args = count($args);
		$new_args = array();
		$open_arg = false;
		for ($i = 1; $i < $num_args; $i++) {

			//------------------------------------------------------
			// Current Argument
			//------------------------------------------------------
			$arg = $args[$i];

			//------------------------------------------------------
			// Next Argument
			//------------------------------------------------------
			$next_arg = (isset($args[$i+1])) ? ($args[$i+1]) : (false);

			//------------------------------------------------------
			// Current Argument's First Character
			//------------------------------------------------------
			$arg_1char = substr($arg, 0, 1);

			//------------------------------------------------------
			// Current Argument's First Two Characters
			//------------------------------------------------------
			$arg_2char = substr($arg, 0, 2);

			//------------------------------------------------------
			// Parse Switches
			//------------------------------------------------------
			if ($arg_1char == '-' && strlen($arg) == 2) {
				$switch = substr($arg, 1);
				if (strlen($switch) > 1) {
					$switches = str_split($switch);
					foreach ($switches as $curr_sw) { $new_args[$curr_sw] = false; }
					$open_arg = $curr_sw;
				}
				else {
					$open_arg = $switch;
					$new_args[$switch] = false;
				}
			}
			else if ($arg_2char == '--') {
				$switch = substr($arg, 2);
				$open_arg = $switch;
				$new_args[$switch] = false;
			}
			//------------------------------------------------------
			// Parse Switches
			//------------------------------------------------------
			else {
				if ($open_arg) {
					$new_args[$open_arg] = $arg;
					$open_arg = false;
				}
				else {
					$new_args['loose_args'][] = $arg;
				}
			}
		}
		return $new_args;
	}

	//#########################################################################
	//#########################################################################
	// Message Printing Methods
	//#########################################################################
	//#########################################################################

	//*************************************************************************
	//*************************************************************************
	// Print Title
	//*************************************************************************
	//*************************************************************************
	protected static function PrintTitle($title)
	{
    	if ($mod_title) {
            print "\n**********************************************************************\n";
            print ">>>>> {$mod_title} <<<<<";
            print "\n**********************************************************************\n";
        }
	}

	//*************************************************************************
	//*************************************************************************
	// Print Output Header
	//*************************************************************************
	//*************************************************************************
	protected static function PrintOutputHeader()
	{
    	$text = 'Job Output';
		print "\n**********************************************************************";
		print "\n*** {$text}";
		print "\n**********************************************************************\n";
    }

	//*************************************************************************
	//*************************************************************************
	// Print Confirmation
	//*************************************************************************
	//*************************************************************************
	protected static function PrintConfirmation($msg, $depth=0)
	{
		self::PrintMessage($msg, $depth, '[ok]');
	}

	//*************************************************************************
	//*************************************************************************
	// Print Warning
	//*************************************************************************
	//*************************************************************************
	protected static function PrintWarning($msg, $depth=0)
	{
		self::PrintMessage($msg, $depth, '[!!]');
	}

	//*************************************************************************
	//*************************************************************************
	// Print Error
	//*************************************************************************
	//*************************************************************************
	protected static function PrintError($msg, $depth=0)
	{
		self::PrintMessage($msg, $depth, "\n** [ERROR] ** :");
	}

	//*************************************************************************
	//*************************************************************************
	// Print Message
	//*************************************************************************
	//*************************************************************************
	protected static function PrintMessage($msg, $depth=0, $prefix='')
	{
		$tabs = '';
		if ($depth) {
			$tabs = str_pad('', $depth, "\t", STR_PAD_LEFT);
		}
		if ($tabs) { print $tabs; }
		if ($prefix) { print "{$prefix} "; }
		print "{$msg}\n";
	}

	//*************************************************************************
	//*************************************************************************
	// Print Error and Exit
	//*************************************************************************
	//*************************************************************************
	protected static function PrintErrorExit($msg)
	{
		print "\n** [ERROR] ** : {$msg}\n";
		print "\n**********************************************************************";
		print "\n*** Exited with Error";
		print "\n**********************************************************************\n\n";
		exit;
	}

}
